#!/usr/bin/env python3

from utils import *
import difflist
import sys
import pprint
import shutil


STREAM = sys.stdin.buffer
if len(sys.argv) > 1:
    CMD = [
        'git',
        '--no-pager',
        'diff-tree',
        # actually display a patch
        '--patch',
        # disable all color
        '--no-color',
        # disable all external diffing helpers
        '--no-ext-diff',
        # disable all gitattributes text conversion
        '--no-textconv',
        # disable word-level diff splitting
        '--word-diff=none',
        # display submodules in the "Subproject commit" format
        '--submodule=short',
    ]
    # pass any remaining args to diff-tree
    # useful flags to try:
    # -M, --find-renames, --no-renames
    # -C, --find-copies, --find-copies-harder
    # -l
    # -B, --break-rewrites
    # -D, --irreversible-delete
    # -U, --unified
    # --diff-algorithm
    # --diff-filter
    # --full-index
    # --binary
    # -S
    # -G
    # -O
    # --src-prefix, --dst-prefix, --no-prefix
    # --root
    CMD.extend(sys.argv[1:])
    import subprocess
    STREAM = subprocess.Popen(CMD, stdout=subprocess.PIPE, universal_newlines=False).stdout

pprint.pprint(
    difflist.DiffList(STREAM),
    indent=4,
    width=shutil.get_terminal_size(
        fallback=(80, 40)
    ).columns,
)
